<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>WinGo Ultra AI - MADARA PRO (Logic 99)</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        // IMPORTANT: Replace with your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBTTVVmV2J4A8QqG9gaTFjhTzDW6RqgNps",
            authDomain: "madara-62f7b.firebaseapp.com",
            projectId: "madara-62f7b",
            databaseURL: "https://madara-62f7b-default-rtdb.firebaseio.com",
            storageBucket: "madara-62f7b.firebasestorage.app",
            appId: "1:282972851212:web:64980ccdfa06b317357229"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        onValue(ref(db, 'prediction_control'), (snapshot) => {
            const data = snapshot.val() || { status: "ON" };
            const predCircles = document.getElementById('prediction-circles');
            const predStatus = document.getElementById('prediction-status-container');
            if(data.status === "OFF") {
                predCircles.style.display = "none";
                predStatus.style.display = "flex";
                predStatus.innerHTML = `<p>${data.message || 'System Maintenance'}</p>`;
            } else {
                predCircles.style.display = "grid";
                predStatus.style.display = "none";
            }
        });
    </script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f8faf8; overflow-x: hidden; }
        .wingo-app-container { max-width: 450px; margin: 0 auto; background-color: #ffffff; min-height: 100vh; padding-bottom: 20px; }
        
        /* Tab Styles with New Color */
        .top-tabs-container { display: flex; padding: 10px 5px; gap: 5px; }
        .tab { display: flex; flex-direction: column; align-items: center; flex-grow: 1; padding: 10px 4px; border-radius: 12px; font-size: 11px; background-color: #e8f5e9; color: #2e7d32; cursor: pointer; transition: 0.1s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab:before { content: ''; display: block; width: 22px; height: 22px; margin-bottom: 4px; background-image: url('https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000481654.png?alt=media'); background-size: contain; filter: hue-rotate(60deg); }
        .tab.active { background-color: #B3EDA9; color: #1b5e20; font-weight: bold; }
        
        .game-info-section { padding: 10px; display: flex; justify-content: center; }
        
        /* Card with New Color Gradient */
        .info-card-container { display: flex; position: relative; background: linear-gradient(135deg, #B3EDA9 0%, #dcf7d7 100%); color: #1b5e20; border-radius: 12px; padding: 15px 12px; width: 92%; max-width: 400px; box-shadow: 0 6px 15px rgba(179, 237, 169, 0.3); overflow: hidden; mask-image: radial-gradient(circle at 50% 0, transparent 12px, black 13px), radial-gradient(circle at 50% 100%, transparent 12px, black 13px); -webkit-mask-image: radial-gradient(circle at 50% 0, transparent 12px, black 13px), radial-gradient(circle at 50% 100%, transparent 12px, black 13px); mask-composite: intersect; -webkit-mask-composite: source-in; }
        .info-card-container::before { content: ''; position: absolute; left: 50%; top: 10px; bottom: 10px; width: 1px; border-left: 2px dotted rgba(27,94,32,0.2); transform: translateX(-50%); }
        
        .info-left, .info-right { flex: 1; z-index: 1; display: flex; flex-direction: column; }
        .info-right { text-align: right; align-items: flex-end; }
        .label-text { font-size: 10px; font-weight: 700; color: #2e7d32; margin-bottom: 6px; text-transform: uppercase; }
        
        /* Timer Segments */
        .timer-display-container { display: flex; align-items: center; gap: 3px; }
        .timer-segment { background-color: #ffffff; color: #1b5e20; width: 20px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 16px; border-radius: 3px; clip-path: polygon(20% 0, 80% 0, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0 80%, 0 20%); }
        
        .recent-res-img { width: 22px; height: 22px; }
        .betting-numbers-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px; min-height: 140px; }
        .number-image-wrapper img { width: 48px; height: 48px; transition: 0.2s; }
        
        /* History Navigation New Color */
        .history-nav-container { display: flex; padding: 0 15px; gap: 4px; }
        .history-nav-btn { padding: 12px; cursor: pointer; background-color: #e8f5e9; flex: 1; text-align: center; color: #2e7d32; font-weight: bold; border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .history-nav-btn.active { background-color: #B3EDA9; color: #1b5e20; }
        
        .history-table-wrapper { max-height: 400px; overflow-y: auto; border: 1px solid #e1eee0; border-radius: 0 0 12px 12px; }
        table { width: 100%; border-collapse: collapse; background: white; text-align: center; }
        th { background: #B3EDA9; color: #1b5e20; padding: 10px 5px; font-size: 12px; position: sticky; top: 0; z-index: 2; }
        td { padding: 12px 5px; font-size: 13px; border-bottom: 1px solid #f1f8f1; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

        @keyframes sequentialJump {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.6; }
            50% { transform: translateY(-15px) scale(1.1); opacity: 1; }
        }
        .bounce-active { animation: sequentialJump 0.4s ease-in-out; }
    </style>
</head>
<body>

<div class="wingo-app-container">
    <div class="top-tabs-container">
        <div class="tab" onclick="changeMode('30s', this)">30s</div>
        <div class="tab active" onclick="changeMode('1 Min', this)">1 Min</div>
        <div class="tab" onclick="changeMode('3 Min', this)">3 Min</div>
        <div class="tab" onclick="changeMode('5 Min', this)">5 Min</div>
    </div>

    <div class="game-info-section">
        <div class="info-card-container">
            <div class="info-left">
                <div id="game-title" style="font-weight: 800; font-size: 14px; margin-bottom: 10px;">WinGo 1Min</div>
                <div class="label-text">Recent Results</div>
                <div id="recent-results-display" style="display: flex; gap: 4px;"></div>
            </div>
            <div class="info-right">
                <div class="label-text">Time Remaining</div>
                <div class="timer-display-container">
                    <span class="timer-segment" id="m1">0</span><span class="timer-segment" id="m2">0</span>
                    <span style="font-weight:bold; color:#1b5e20;">:</span>
                    <span class="timer-segment" id="s1">0</span><span class="timer-segment" id="s2">0</span>
                </div>
                <div style="font-size: 11px; font-weight: 700; color: #2e7d32;"><span id="period-id">0000</span></div>
            </div>
        </div>
    </div>

    <div id="prediction-status-container"></div>
    <div class="betting-numbers-container" id="prediction-circles"></div>

    <div class="history-nav-container">
        <div id="game-history-btn" class="history-nav-btn active">Game History</div>
        <div id="my-history-btn" class="history-nav-btn">My History</div>
    </div>

    <div style="padding: 0 15px;">
        <div id="game-history-table" class="history-table-wrapper">
            <table>
                <thead><tr><th>Period</th><th>Number</th><th>Size</th><th>Color</th></tr></thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
        <div id="my-history-content" class="history-table-wrapper" style="display:none;">
            <table>
                <thead><tr><th>Period</th><th>Prediction</th><th>Status</th></tr></thead>
                <tbody id="my-history-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const IMG = { 
        Q: 'https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000481647.png?alt=media', 
        BIG: 'https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000481648.png?alt=media', 
        SML: 'https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000481650.png?alt=media' 
    };
    const NUM_IMG = { 0: 'https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000482339.png?alt=media', 1: 'https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000482340.png?alt=media', 2: 'https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000482341.png?alt=media', 3: 'https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000482342.png?alt=media', 4: 'https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000482343.png?alt=media', 5: 'https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000482344.png?alt=media', 6: 'https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000482345.png?alt=media', 7: 'https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000482346.png?alt=media', 8: 'https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000482347.png?alt=media', 9: 'https://firebasestorage.googleapis.com/v0/b/i-to-u.appspot.com/o/publicimage%2F1000482348.png?alt=media' };

    class IsolatedEngine {
        constructor() {
            this.rawHistory = { "30s": [], "1 Min": [], "3 Min": [], "5 Min": [] };
            this.userPredictions = { "30s": [], "1 Min": [], "3 Min": [], "5 Min": [] };
        }
        
        /**
         * Logic 99: Last 4 Results Analysis (Streak Reversal / Majority Rule)
         * This is the new calculation logic as requested.
         */
        predict(mode) {
            const rawH = this.rawHistory[mode];
            if (rawH.length < 4) return Math.random() > 0.5 ? "BIG" : "SMALL"; // Default if not enough history

            // Get only the most recent 4 results (rawH is reversed, so last 4 elements are oldest, but we take first 4)
            const lastFourResults = rawH.slice(0, 4); 
            
            let bigCount = 0;
            let smallCount = 0;

            lastFourResults.forEach(res => {
                if (res === "BIG") bigCount++;
                else if (res === "SMALL") smallCount++;
            });

            let prediction;

            // 1. Extreme Streak Reversal (BBBB -> SMALL / SSSS -> BIG)
            if (bigCount === 4) {
                prediction = "SMALL";
            } 
            else if (smallCount === 4) {
                prediction = "BIG";
            } 
            // 2. Strong Majority 
            else if (bigCount > smallCount) {
                prediction = "BIG"; 
            } 
            else if (smallCount > bigCount) {
                prediction = "SMALL";
            } 
            // 3. Balanced Pattern (2 BIG, 2 SMALL) -> Predict Opposite of Last (index 0 is the most recent)
            else { 
                prediction = lastFourResults[0] === "BIG" ? "SMALL" : "BIG";
            }

            return prediction;
        }
    }

    const engine = new IsolatedEngine();
    let currentMode = "1 Min", lastPeriodStored = { "30s": "", "1 Min": "", "3 Min": "", "5 Min": "" }, modeDisplayState = { "30s": "", "1 Min": "", "3 Min": "", "5 Min": "" }, isAnimating = false;

    window.changeMode = (mode, el) => {
        currentMode = mode;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('game-title').innerText = "WinGo " + mode;
        document.getElementById('prediction-circles').innerHTML = modeDisplayState[currentMode];
        updateData(true);
        updateMyHistoryUI();
    };

    async function updateData(modeSwitch = false) {
        try {
            const api = currentMode === "30s" ? "30S" : (currentMode === "1 Min" ? "1M" : (currentMode === "3 Min" ? "3M" : "5M"));
            const res = await fetch(`https://draw.ar-lottery01.com/WinGo/WinGo_${api}/GetHistoryIssuePage.json?ts=${Date.now()}`);
            const json = await res.json();
            const list = json.data.list;
            
            // The list is in chronological order, list[0] is the latest result
            const currentP = list[0].issueNumber;
            const nextP = (BigInt(currentP) + 1n).toString();
            
            // Store history in reverse chronological order (latest result first)
            engine.rawHistory[currentMode] = list.slice(0, 50).map(i => parseInt(i.number) >= 5 ? "BIG" : "SMALL");
            
            if (currentP !== lastPeriodStored[currentMode]) {
                lastPeriodStored[currentMode] = currentP;
                runAnimation(nextP);
            } else if (modeSwitch && !modeDisplayState[currentMode]) {
                showFinalPrediction(nextP, false);
            }
            renderTables(list);
        } catch(e) {}
    }

    async function showFinalPrediction(nextP, updateHist = true) {
        if(isAnimating) return;
        const p = engine.predict(currentMode); // Use the new Logic 99 prediction
        const stop = Math.floor(Math.random() * 10);
        const html = Array.from({length:10}, (_,i) => {
            const isW = i === stop;
            const s = isW ? 'style="transform:scale(1.2);"' : 'style="opacity:0.6;"';
            return `<div class="number-image-wrapper"><img src="${isW ? (p==='BIG'?IMG.BIG:IMG.SML) : IMG.Q}" ${s}></div>`;
        }).join('');
        document.getElementById('prediction-circles').innerHTML = html;
        modeDisplayState[currentMode] = html;
        if (updateHist && !engine.userPredictions[currentMode].some(u => u.period === nextP)) {
            engine.userPredictions[currentMode].unshift({ period: nextP, pred: p, status: "Pending" });
            updateMyHistoryUI();
        }
    }

    function runAnimation(nextP) {
        if (isAnimating) return; isAnimating = true;
        document.getElementById('prediction-circles').innerHTML = Array.from({length:10}, (_,i) => `<div class="number-image-wrapper" id="ball-${i}"><img src="${IMG.Q}" style="opacity:0.6;"></div>`).join('');
        let curr = 0, loops = 0;
        const interval = setInterval(() => {
            document.querySelectorAll('.number-image-wrapper img').forEach(img => img.classList.remove('bounce-active'));
            const ball = document.getElementById(`ball-${curr % 10}`);
            if(ball) ball.querySelector('img').classList.add('bounce-active');
            curr++; loops++;
            if (loops > 20) { clearInterval(interval); isAnimating = false; showFinalPrediction(nextP, true); }
        }, 120);
    }

    function renderTables(list) {
        document.getElementById('period-id').textContent = (BigInt(list[0].issueNumber) + 1n).toString();
        document.getElementById('recent-results-display').innerHTML = list.slice(0, 4).map(i => `<img src="${NUM_IMG[parseInt(i.number)]}" class="recent-res-img">`).join('');
        
        // Game History Table Rendering
        document.getElementById('history-body').innerHTML = list.slice(0, 10).map(i => {
            const n = parseInt(i.number), 
                  c = (n==0||n==5) ? '#a020f0' : (n%2==0 ? '#ff3366' : '#279010'); // Violet/Red/Green Color Logic
            return `<tr><td>${i.issueNumber}</td><td style="color:${c};font-weight:bold">${n}</td><td>${n>=5?'Big':'Small'}</td><td><span class="dot" style="background:${c}"></span></td></tr>`;
        }).join('');
        
        // Update My History Status
        engine.userPredictions[currentMode].forEach(u => {
            const m = list.find(l => l.issueNumber === u.period);
            if(m && u.status === "Pending") u.status = (u.pred === (parseInt(m.number) >= 5 ? "BIG" : "SMALL")) ? "WIN" : "LOSS";
        });
        updateMyHistoryUI();
    }

    function updateMyHistoryUI() {
        const hist = engine.userPredictions[currentMode] || [];
        document.getElementById('my-history-body').innerHTML = hist.map(u => `<tr><td>${u.period}</td><td>${u.pred}</td><td style="color:${u.status==='WIN'?'#279010':(u.status==='LOSS'?'#ff3366':'orange')}; font-weight:bold;">${u.status}</td></tr>`).join('');
    }

    setInterval(() => {
        const now = new Date();
        const sTotal = now.getSeconds() + now.getMinutes() * 60;
        let t = 60;
        if(currentMode==="30s") t=30; else if(currentMode==="3 Min") t=180; else if(currentMode==="5 Min") t=300;
        let rem = t - (sTotal % t);
        
        // Timer display logic
        const minutes = Math.floor(rem/60);
        const seconds = rem % 60;
        document.getElementById('m1').textContent = Math.floor(minutes/10); 
        document.getElementById('m2').textContent = minutes % 10;
        document.getElementById('s1').textContent = Math.floor(seconds/10); 
        document.getElementById('s2').textContent = seconds % 10;
        
        if (rem === t || rem === 1) updateData(); // Trigger data update when timer hits 0 or 1 second remaining
    }, 1000);

    window.onload = () => {
        const q = Array.from({length:10}, () => `<div class="number-image-wrapper"><img src="${IMG.Q}" style="opacity:0.6;"></div>`).join('');
        modeDisplayState = { "30s": q, "1 Min": q, "3 Min": q, "5 Min": q };
        document.getElementById('prediction-circles').innerHTML = q;
        updateData();
    };

    document.getElementById('game-history-btn').onclick = () => { document.getElementById('game-history-table').style.display='block'; document.getElementById('my-history-content').style.display='none'; document.getElementById('game-history-btn').classList.add('active'); document.getElementById('my-history-btn').classList.remove('active'); };
    document.getElementById('my-history-btn').onclick = () => { document.getElementById('my-history-content').style.display='block'; document.getElementById('game-history-table').style.display='none'; document.getElementById('my-history-btn').classList.add('active'); document.getElementById('game-history-btn').classList.remove('active'); updateMyHistoryUI(); };
</script>
</body>
</html>
